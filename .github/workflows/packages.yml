name: x86_64 OpenWrt Packages Builder
on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'Enable SSH connection to Actions'
        required: false
        default: 'false'
        type: boolean
  repository_dispatch:

env:
  OPNAME: 'x86_64im'
  # 改为 ImmortalWrt 源（im 的）
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  # 使用 openwrt-24.10 分支（对应 OpenWrt 24.10，内核 6.6）
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  EXTERNAL_FILE: configs/luci/test.config
  CONFIG_FILE: configs/x86_64.config
  SYS_CONF_SH: configurenew.sh
  PACKS: package.sh
  EXTEND_DRIVER: false
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: false  # 关闭固件生成
  UPLOAD_RELEASE: false   # 关闭 Release 发布
  WORKDIR: /mnt/openwrt_workdir
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. 检出仓库
      - name: 检出仓库
        uses: actions/checkout@v4

      # 2. 初始化系统环境
      - name: 初始化系统环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/*
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/bigbugcc/openwrts/master/openwrt-env)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p $WORKDIR
          sudo chown $USER:$GROUPS $WORKDIR
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f
          df -hT
          # Install Go if not installed
          if ! command -v go &>/dev/null; then
          echo "Go not found, installing..."
            sudo apt-get -qq install golang-go
          else
            echo "Go is already installed"
          fi
          # Check Go version
          go version
      - name: 检查磁盘空间
        run: df -hT

      # 3. 克隆 OpenWrt 源码
      - name: 克隆 OpenWrt 源码
        working-directory: ${{ env.WORKDIR }}
        run: |
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
          ln -sf $WORKDIR/openwrt $GITHUB_WORKSPACE/openwrt

      # 4. 使用 cache 加速编译
      - name: 缓存编译
        uses: stupidloud/cachewrtbuild@main
        with:
          ccache: 'true'
          mixkey: 'x86'
          prefix: 'openwrt'

      - name: 检查磁盘空间
        run: df -hT

      # 5. 更新 feeds
      - name: 更新并安装 feeds
        run: |
          cd $WORKDIR/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      - name: 检查磁盘空间
        run: df -hT

      # 6. 自定义 feeds 和脚本
      - name: 加载自定义 feeds 和脚本
        run: |
          cd $WORKDIR/openwrt
          [ -e $GITHUB_WORKSPACE/$FEEDS_CONF ] && mv $GITHUB_WORKSPACE/$FEEDS_CONF feeds.conf.default
          chmod +x $GITHUB_WORKSPACE/$SYS_CONF_SH
          bash $GITHUB_WORKSPACE/$SYS_CONF_SH

      # 7. 加载自定义配置和 package.sh
      - name: 加载自定义配置和 package.sh
        run: |
          cd $WORKDIR/openwrt
          [ -e $GITHUB_WORKSPACE/files ] && mv $GITHUB_WORKSPACE/files files
          [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && mv $GITHUB_WORKSPACE/$CONFIG_FILE .config
          chmod +x $GITHUB_WORKSPACE/$PACKS
          bash $GITHUB_WORKSPACE/$PACKS

      # 8. 修改配置以仅生成 packages
      - name: 修改配置以仅生成 packages
        run: |
          cd $WORKDIR/openwrt
          # 禁用镜像生成
          sed -i 's/CONFIG_ISO_IMAGES=y/# CONFIG_ISO_IMAGES is not set/' .config
          sed -i 's/CONFIG_VDI_IMAGES=y/# CONFIG_VDI_IMAGES is not set/' .config
          sed -i 's/CONFIG_VMDK_IMAGES=y/# CONFIG_VMDK_IMAGES is not set/' .config
          sed -i 's/CONFIG_VHDX_IMAGES=y/# CONFIG_VHDX_IMAGES is not set/' .config
          # 禁用根文件系统镜像
          sed -i 's/CONFIG_TARGET_ROOTFS_EXT4FS=y/# CONFIG_TARGET_ROOTFS_EXT4FS is not set/' .config
          sed -i 's/CONFIG_TARGET_ROOTFS_SQUASHFS=y/# CONFIG_TARGET_ROOTFS_SQUASHFS is not set/' .config
          # 添加外部配置文件
          cat $GITHUB_WORKSPACE/$EXTERNAL_FILE >> .config
          make defconfig

      # 9. 扩展驱动（Lite 不启用）
      - name: 扩展驱动
        if: env.EXTEND_DRIVER == 'true'
        run: |
          cd $WORKDIR/openwrt
          cat $GITHUB_WORKSPACE/configs/Driver.config >> .config

      # 10. 输出并保存最终 .config
      - name: 输出并保存最终 .config
        run: |
          cd $WORKDIR/openwrt
          echo "======== 当前 OpenWrt 配置 ========"
          cat .config
          echo "==================================="
          # 保存备份文件到 workdir，带时间戳
          cp .config $WORKDIR/openwrt/.config_backup_$(date +'%Y%m%d%H%M%S')
          echo "已保存 .config 备份文件"

      # 11. 启动 SSH 连接 (tmate) 如果用户选择启用
      - name: 启动 SSH 连接
        if: ${{ inputs.ssh == true }}
        uses: mxschmitt/action-tmate@v3.13
        continue-on-error: true

      # 12. 下载 dl 包
      - name: 下载依赖包
        run: |
          cd $WORKDIR/openwrt
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;
      - name: 检查磁盘空间
        run: df -hT


      # 13. 编译 packages
      - name: 编译 OpenWrt Packages
        id: compile_packages
        run: |
          cd $WORKDIR/openwrt
          echo "$(nproc) thread compile packages"
          # 仅编译 packages，不编译镜像
          make package/compile -j$(nproc)  || make package/compile -j4 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "DEVICE_NAME=_x86_64Lite" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +'%Y%m%d%H%M')" >> $GITHUB_ENV

      # 14. 清理编译缓存
      - name: 清理编译缓存
        if: steps.compile_packages.outputs.status == 'success'
        run: |
          cd $WORKDIR/openwrt
          rm -rf build_dir staging_dir tmp .ccache
          # 保留 bin/packages 目录
          df -hT

      # 15. 压缩 packages 文件夹
      - name: 压缩 packages 文件夹
        id: package_compress
        if: steps.compile_packages.outputs.status == 'success'
        run: |
          cd $WORKDIR/openwrt/bin
          # 确保 packages 文件夹存在
          if [ -d "packages" ]; then
            echo "packages 文件夹存在，开始压缩..."
            # 列出 packages 内容
            ls -la packages/
            # 压缩 packages 文件夹
            tar -czvf OpenWrt_packages_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}.tar.gz packages
            # 获取文件信息
            echo "压缩完成，文件信息："
            ls -lh OpenWrt_packages_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}.tar.gz
            # 将压缩包复制到工作区
            cp OpenWrt_packages_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}.tar.gz $GITHUB_WORKSPACE/
            echo "status=success" >> $GITHUB_OUTPUT
            echo "PACKAGE_FILE=OpenWrt_packages_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}.tar.gz" >> $GITHUB_ENV
          else
            echo "错误：packages 文件夹不存在"
            ls -la
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      # 16. 创建 packages 索引文件
      - name: 创建 packages 索引文件
        if: steps.package_compress.outputs.status == 'success'
        run: |
          cd $WORKDIR/openwrt/bin/packages
          # 创建 Packages 索引文件
          ../../scripts/ipkg-make-index.sh . > Packages
          gzip -c Packages > Packages.gz
          # 复制索引文件到压缩包目录
          cp Packages Packages.gz $WORKDIR/openwrt/bin/
          echo "已创建 packages 索引文件"

      # 17. 上传 packages 压缩包
      - name: 上传 packages 压缩包
        if: steps.package_compress.outputs.status == 'success'
        uses: actions/upload-artifact@main
        with:
          name: OpenWrt_Packages_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
          path: |
            ${{ github.workspace }}/OpenWrt_packages_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}.tar.gz
            $WORKDIR/openwrt/bin/Packages
            $WORKDIR/openwrt/bin/Packages.gz
          retention-days: 7

      # 18. 输出 packages 信息
      - name: 输出 packages 信息
        if: steps.package_compress.outputs.status == 'success'
        run: |
          echo "========================================="
          echo "Packages 生成完成！"
          echo "文件名: ${{ env.PACKAGE_FILE }}"
          echo "生成时间: ${{ env.FILE_DATE }}"
          echo "========================================="
          cd $WORKDIR/openwrt/bin/packages
          echo "包含的 packages 数量:"
          find . -name "*.ipk" | wc -l
          echo "前 20 个 packages:"
          find . -name "*.ipk" | head -20