name: Build Passwall Package

on:
  workflow_dispatch:
    inputs:
      lan_ip:
        description: '默认 LAN IP 地址'
        required: true
        default: '192.168.100.11'
      pppoe_user:
        description: 'PPPoE 用户名'
        required: true
        default: '123456'
      pppoe_pass:
        description: 'PPPoE 密码'
        required: true
        default: '123456'
  repository_dispatch:

env:
  OPNAME: 'x86_64Lite'
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  EXTERNAL_FILE: configs/luci/diy.config
  CONFIG_FILE: configs/x86_64.config
  SYS_CONF_SH: configurenew.sh
  PACKS: package.sh
  EXTEND_DRIVER: false
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  WORKDIR: /mnt/openwrt_workdir
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. 检出仓库
      - name: 检出仓库
        uses: actions/checkout@v4

      # 2. 初始化系统环境
      - name: 初始化系统环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/*
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/bigbugcc/openwrts/master/openwrt-env)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p $WORKDIR
          sudo chown $USER:$GROUPS $WORKDIR
          sudo docker image prune -a -f
          df -hT

          # Install Go if not installed
          if ! command -v go &>/dev/null; then
            echo "Go not found, installing..."
            sudo apt-get -qq install golang-go
          else
            echo "Go is already installed"
          fi

          # Check Go version
          go version

      # 3. 克隆 OpenWrt 源码
      - name: 克隆 OpenWrt 源码
        working-directory: ${{ env.WORKDIR }}
        run: |
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
          ln -sf $WORKDIR/openwrt $GITHUB_WORKSPACE/openwrt

      # 4. 更新 feeds
      - name: 更新并安装 feeds
        run: |
          cd $WORKDIR/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. 删除 OpenWrt 自带核心包（防止冲突）
      - name: 删除 OpenWrt 自带核心包
        run: |
          echo ">>> Removing stock core network packages..."
          rm -rf $WORKDIR/openwrt/feeds/packages/net/{xray-core,v2ray-geodata,sing-box,chinadns-ng,dns2socks,hysteria,ipt2socks,microsocks,naiveproxy,shadowsocks-libev,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan-plus,tuic-client,v2ray-plugin,xray-plugin,geoview,shadow-tls}
          echo ">>> Stock core packages removed"

      # 6. 克隆 Passwall 包
      - name: 克隆 Passwall 包
        run: |
          echo ">>> Cloning Passwall packages..."
          git clone https://github.com/xiaorouji/openwrt-passwall-packages $WORKDIR/openwrt/package/passwall-packages
          echo ">>> New passwall-packages cloned"

      # 7. 删除旧版 luci-app-passwall 并替换新版
      - name: 删除并替换 luci-app-passwall
        run: |
          echo ">>> Removing outdated luci-app-passwall..."
          rm -rf $WORKDIR/openwrt/feeds/luci/applications/luci-app-passwall
          git clone https://github.com/xiaorouji/openwrt-passwall $WORKDIR/openwrt/package/passwall-luci
          echo ">>> New luci-app-passwall cloned"

      # 8. 更新 feeds 和安装
      - name: 更新并安装自定义 Feeds
        run: |
          cd $WORKDIR/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 9. 加载自定义配置
      - name: 加载自定义配置
        run: |
          cd $WORKDIR/openwrt
          [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && mv $GITHUB_WORKSPACE/$CONFIG_FILE .config
          make defconfig

      # 10. 编译 Passwall 包
      - name: 编译 Passwall 包
        run: |
          cd $WORKDIR/openwrt
          make package/feeds/passwall/luci-app-passwall/compile V=s
          echo "status=success" >> $GITHUB_OUTPUT

      # 11. 上传 Passwall 包到 Artifact
      - name: 上传 Passwall .ipk 包
        uses: softprops/action-gh-release@v1
        if: steps.compile.outputs.status == 'success'
        with:
          name: passwall_package_${{ github.event.inputs.passwall_version }}_${{ github.run_id }}
          path: $WORKDIR/openwrt/bin/packages/*/*/passwall*.ipk

      # 12. 清理编译缓存
      - name: 清理编译缓存
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $WORKDIR/openwrt
          rm -rf build_dir staging_dir tmp bin/packages .ccache
          df -hT
