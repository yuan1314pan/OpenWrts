name: Build Passwall Package

on:
  workflow_dispatch:
    inputs:
      passwall_version:
        description: '指定 Passwall 版本（默认最新）'
        required: true
        default: 'latest'
  repository_dispatch:

env:
  OPNAME: 'x86_64im'
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: configs/x86_64.config
  PACKS: package.sh
  EXTEND_DRIVER: false
  UPLOAD_BIN_DIR: true
  WORKDIR: /mnt/openwrt_workdir
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. 检出仓库
      - name: 检出仓库
        uses: actions/checkout@v4

      # 2. 初始化系统环境
      - name: 初始化系统环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/*
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/bigbugcc/openwrts/master/openwrt-env)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p $WORKDIR
          sudo chown $USER:$GROUPS $WORKDIR
          sudo docker image prune -a -f
          df -hT

          # Install Go if not installed
          if ! command -v go &>/dev/null; then
            echo "Go not found, installing..."
            sudo apt-get -qq install golang-go
          else
            echo "Go is already installed"
          fi

          # Check Go version
          go version

      # 3. 克隆 OpenWrt 源码
      - name: 克隆 OpenWrt 源码
        working-directory: ${{ env.WORKDIR }}
        run: |
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
          ln -sf $WORKDIR/openwrt $GITHUB_WORKSPACE/openwrt

      # 4. 更新 feeds
      - name: 更新并安装 feeds
        run: |
          cd $WORKDIR/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. 自定义 feeds 和脚本
      - name: 加载自定义 feeds 和脚本
        run: |
          cd $WORKDIR/openwrt
          [ -e $GITHUB_WORKSPACE/$FEEDS_CONF ] && mv $GITHUB_WORKSPACE/$FEEDS_CONF feeds.conf.default
          chmod +x $GITHUB_WORKSPACE/$PACKS
          bash $GITHUB_WORKSPACE/$PACKS

      # 6. 加载自定义配置
      - name: 加载自定义配置
        run: |
          cd $WORKDIR/openwrt
          [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && mv $GITHUB_WORKSPACE/$CONFIG_FILE .config
          make defconfig

      # 7. 更新 Passwall 版本
      - name: 更新 Passwall 包
        run: |
          cd $WORKDIR/openwrt
          if [ "${{ github.event.inputs.passwall_version }}" != "latest" ]; then
            # 如果用户指定了版本，则下载该版本
            git clone --depth 1 -b ${{ github.event.inputs.passwall_version }} https://github.com/xiaorouji/openwrt-passwall.git package/feeds/passwall
          else
            # 否则使用最新版本
            git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall.git package/feeds/passwall
          fi

      # 8. 编译 Passwall 包
      - name: 编译 Passwall 包
        run: |
          cd $WORKDIR/openwrt
          make package/feeds/passwall/passwall/compile V=s
          echo "status=success" >> $GITHUB_OUTPUT

      # 9. 上传 Passwall 包到 Artifact
      - name: 上传 Passwall .ipk 包
        uses: actions/upload-artifact@v2
        if: steps.compile.outputs.status == 'success'
        with:
          name: passwall_package_${{ github.event.inputs.passwall_version }}_${{ github.run_id }}
          path: $WORKDIR/openwrt/bin/packages/*/*/passwall*.ipk

      # 10. 清理编译缓存
      - name: 清理编译缓存
        if: steps.compile.outputs.status == 'success'
        run: |
          cd $WORKDIR/openwrt
          rm -rf build_dir staging_dir tmp bin/packages .ccache
          df -hT
