name: OpenWrt 编译 test
on:
  workflow_dispatch:
    inputs:
      lan_ip:
        description: '默认 LAN IP 地址'
        required: true
        default: '192.168.100.11'
      pppoe_user:
        description: 'PPPoE 用户名'
        required: true
        default: '123456'
      pppoe_pass:
        description: 'PPPoE 密码'
        required: true
        default: '123456'
      ssh:
        description: '是否启用 SSH 连接到 Actions'
        required: false
        default: 'false'
        type: boolean
  repository_dispatch:

env:
  OPNAME: 'x86_64im'
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  EXTERNAL_FILE: configs/luci/test.config
  CONFIG_FILE: configs/x86_64.config
  SYS_CONF_SH: configurenew.sh
  PACKS: package.sh
  EXTEND_DRIVER: false
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  WORKDIR: /mnt/openwrt_workdir
  TZ: Asia/Shanghai
  FIRMWARE: $WORKDIR/openwrt/bin/targets/x86/64

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. 检出仓库
      - name: 检出仓库
        uses: actions/checkout@v4

      # 2. 初始化系统环境
      - name: 初始化系统环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/*
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/bigbugcc/openwrts/master/openwrt-env)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p $WORKDIR
          sudo chown $USER:$GROUPS $WORKDIR
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f

      # 3. 克隆 ImmortalWrt 仓库
      - name: 克隆 ImmortalWrt 仓库
        run: |
          echo "克隆 ImmortalWrt 仓库..."
          git clone --depth 1 -b "$REPO_BRANCH" "$REPO_URL" $WORKDIR/openwrt || echo "仓库克隆失败，请检查网络连接"

      # 4. 配置官方 feeds
      - name: 配置官方 feeds
        run: |
          echo "配置官方 feeds..."
          cat > $WORKDIR/openwrt/feeds.conf.default << 'EOF'
          src-git packages https://github.com/openwrt/packages.git;openwrt-24.10
          src-git luci https://github.com/openwrt/luci.git;openwrt-24.10
          src-git routing https://github.com/openwrt/routing.git;openwrt-24.10
          src-git telephony https://github.com/openwrt/telephony.git;openwrt-24.10
          EOF
          cd $WORKDIR/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. 下载自定义包到统一目录
      - name: 下载自定义包
        run: |
          echo "下载自定义包到统一目录..."
          CUSTOM_DIR="package/custom"
          mkdir -p "$CUSTOM_DIR"
          clone_to_custom() {
            local url="$1"
            local name="$2"
            local target_dir="$CUSTOM_DIR/$name"
            if [ ! -d "$target_dir" ]; then
              echo "下载: $name"
              if git clone --depth 1 "$url" "$target_dir" 2>/dev/null; then
                echo "  ✓ 下载成功"
                return 0
              else
                echo "  ✗ 下载失败"
                return 1
              fi
            else
              echo "已存在: $name"
              return 0
            fi
          }

          clone_to_custom "https://github.com/linkease/istore.git" "istore"
          clone_to_custom "https://github.com/sirpdboy/luci-app-advancedplus.git" "luci-app-advancedplus"
          clone_to_custom "https://github.com/sirpdboy/luci-theme-kucat.git" "luci-theme-kucat"
          clone_to_custom "https://github.com/sirpdboy/luci-app-kucat-config.git" "luci-app-kucat-config"
          clone_to_custom "https://github.com/kenzok8/openwrt-packages.git" "kenzo"
          clone_to_custom "https://github.com/kenzok8/small.git" "small"

          cd $WORKDIR/openwrt
          ./scripts/feeds update -a
          rm -rf feeds/luci/applications/luci-app-mosdns
          rm -rf feeds/packages/net/{alist,adguardhome,mosdns,xray*,v2ray*,v2ray*,sing*,smartdns}
          rm -rf feeds/packages/utils/v2dat
          rm -rf feeds/packages/lang/golang
          git clone https://github.com/kenzok8/golang feeds/packages/lang/golang
          ./scripts/feeds install -a

      # 6. 生成配置
      - name: 生成配置
        run: |
          echo "生成配置..."
          cd $WORKDIR/openwrt
          make defconfig

      # 7. 添加自定义配置，使用外部的 test.config 文件
      - name: 添加自定义配置
        run: |
          echo "从外部配置文件添加自定义配置..."
          if [ -f "$WORKDIR/$EXTERNAL_FILE" ]; then
            cat $WORKDIR/$EXTERNAL_FILE >> $WORKDIR/openwrt/.config
          else
            echo "$EXTERNAL_FILE not found."
          fi

      # 8. 处理配置
      - name: 处理配置
        run: |
          echo "处理配置..."
          cd $WORKDIR/openwrt
          yes "" | make oldconfig

      # 8.1 自动注入 LAN IP + PPPoE 信息
      - name: 自动注入 LAN IP 和 PPPoE
        run: |
          mkdir -p $WORKDIR/openwrt/files/etc/uci-defaults
          printf '#!/bin/sh\n' > $WORKDIR/openwrt/files/etc/uci-defaults/99-set-network
          printf '# 自动注入 LAN IP + PPPoE 信息\n' >> $WORKDIR/openwrt/files/etc/uci-defaults/99-set-network
          printf 'sed -i "s/192\.168\.[0-9]\{1,3\}\.[0-9]\{1,3\}/${{ github.event.inputs.lan_ip }}/g" /etc/config/network\n' >> $WORKDIR/openwrt/files/etc/uci-defaults/99-set-network
          printf 'uci set network.wan.proto="pppoe"\n' >> $WORKDIR/openwrt/files/etc/uci-defaults/99-set-network
          printf 'uci set network.wan.username="${{ github.event.inputs.pppoe_user }}"\n' >> $WORKDIR/openwrt/files/etc/uci-defaults/99-set-network
          printf 'uci set network.wan.password="${{ github.event.inputs.pppoe_pass }}"\n' >> $WORKDIR/openwrt/files/etc/uci-defaults/99-set-network
          printf 'uci commit network\n' >> $WORKDIR/openwrt/files/etc/uci-defaults/99-set-network
          printf 'exit 0\n' >> $WORKDIR/openwrt/files/etc/uci-defaults/99-set-network

      # 9. 开始编译
      - name: 开始编译
        run: |
          echo "开始编译 OpenWrt..."
          make download -j$(nproc)
          make -j$(nproc) V=s || make -j4 V=s

      # 10. 生成 Release 标签
      - name: 生成 Release tag
        id: tag
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M%S")" >> $GITHUB_OUTPUT
          touch release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      # 11. 生成 Release 内容
      - name: 生成 Release 内容
        run: |
          echo "![](https://img.shields.io/github/downloads/${{ github.repository }}/${{ steps.tag.outputs.release_tag }}/total?style=flat-square)" >> release.txt

      # 12. 上传固件到 Release
      - name: 上传固件到 Release
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: ${{ env.OPNAME }}
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

     
